import {describe, it, mock, after} from 'node:test';
import assert from 'node:assert';
import * as child_process from 'child_process';
import {get_unresolved_comments} from './tools.ts';
import type {GerritComment} from './tools.ts';

describe('get_unresolved_comments tool', () => {
  after(() => {
    mock.reset();
  });

  const mockFetch = (commentsText: string) => {
    const response = {
      text: async () => commentsText,
    };
    return async () => response;
  };

  it('should return unresolved comments from the fixture', async () => {
    const commentsText = getCommentFixture();
    mock.method(global, 'fetch', mockFetch(commentsText));

    const result = await get_unresolved_comments({}, {});
    assert.deepStrictEqual(result, {
      content: [
        {
          type: 'text',
          text: 'No unresolved comments found.',
        },
      ],
    });
  });

  it('should consider a thread unresolved if the last comment does not resolve it', async () => {
    const commentsByFile = {
      'file1.ts': [
        {id: '1', message: 'comment 1', unresolved: true, updated: '2024-01-01T12:00:00Z'},
        {
          id: '2',
          in_reply_to: '1',
          message: 'another comment',
          unresolved: true,
          updated: '2024-01-01T12:05:00Z',
        },
      ],
    };
    mock.method(global, 'fetch', mockFetch(JSON.stringify(commentsByFile)));
    const result = await get_unresolved_comments({}, {});
    assert.deepStrictEqual(result, {
      content: [
        {
          type: 'text',
          text:
            'Unresolved comments for CL 12345:\n\n1. file1.ts\ncomment 1\n\n2. file1.ts\nanother comment',
        },
      ],
    });
  });
});

function getCommentFixture() {
  return ')]}\'\n{"/PATCHSET_LEVEL":[{"author":{"_account_id":1118499,"name":"Paul Irish","email":"paulirish@chromium.org","avatars":[{"url":"https://lh3.googleusercontent.com/-qmEIdivxI5k/AAAAAAAAAAI/AAAAAAAAAAA/pABmS92o3js/s32-p/photo.jpg","height":32},{"url":"https://lh3.googleusercontent.com/-qmEIdivxI5k/AAAAAAAAAAI/AAAAAAAAAAA/pABmS92o3js/s56-p/photo.jpg","height":56},{"url":"https://lh3.googleusercontent.com/-qmEIdivxI5k/AAAAAAAAAAI/AAAAAAAAAAA/pABmS92o3js/s100-p/photo.jpg","height":100},{"url":"https://lh3.googleusercontent.com/-qmEIdivxI5k/AAAAAAAAAAI/AAAAAAAAAAA/pABmS92o3js/s120-p/photo.jpg","height":120}],"tags":["GOOGLER"]},"change_message_id":"5b9087f1a06ee2c880626e53e853216ac1659155","unresolved":false,"context_lines":[],"source_content_type":"","patch_set":11,"id":"86cae346_7adc24cc","updated":"2025-06-18 19:47:14.000000000","message":"andres, shall we take this over?","commit_id":"ec6b7ca7456528616fcbb63e0f23c913686ffe02"},{"author":{"_account_id":1447167,"name":"Andres Olivares","email":"andoli@chromium.org","avatars":[{"url":"https://lh3.googleusercontent.com/-cdKplcLtL7k/AAAAAAAAAAI/AAAAAAAAAAA/UQiu0rgS-7k/s32-p/photo.jpg","height":32},{"url":"https://lh3.googleusercontent.com/-cdKplcLtL7k/AAAAAAAAAAI/AAAAAAAAAAA/UQiu0rgS-7k/s56-p/photo.jpg","height":56},{"url":"https://lh3.googleusercontent.com/-cdKplcLtL7k/AAAAAAAAAAI/AAAAAAAAAAA/UQiu0rgS-7k/s100-p/photo.jpg","height":100},{"url":"https://lh3.googleusercontent.com/-cdKplcLtL7k/AAAAAAAAAAI/AAAAAAAAAAA/UQiu0rgS-7k/s120-p/photo.jpg","height":120}]},"change_message_id":"8fa9e2f9070973ef4b78e956f24e7e5194d6e537","unresolved":false,"context_lines":[],"source_content_type":"","patch_set":11,"id":"47b0ac3e_c9c88339","in_reply_to":"400e3d33_4fda66db","updated":"2025-06-20 16:05:52.000000000","message":"I also moved DecoratorType from SourceFrame.ts into UISourceCode.ts to avoid circular deps, and that causes a good chunk of the diffs in the CL. Might be worth doing that as a separate CL as well.","commit_id":"ec6b7ca7456528616fcbb63e0f23c913686ffe02"},{"author":{"_account_id":1447167,"name":"Andres Olivares","email":"andoli@chromium.org","avatars":[{"url":"https://lh3.googleusercontent.com/-cdKplcLtL7k/AAAAAAAAAAI/AAAAAAAAAAA/UQiu0rgS-7k/s32-p/photo.jpg","height":32},{"url":"https://lh3.googleusercontent.com/-cdKplcLtL7k/AAAAAAAAAAI/AAAAAAAAAAA/UQiu0rgS-7k/s56-p/photo.jpg","height":56},{"url":"https://lh3.googleusercontent.com/-cdKplcLtL7k/AAAAAAAAAAI/AAAAAAAAAAA/UQiu0rgS-7k/s100-p/photo.jpg","height":100},{"url":"https://lh3.googleusercontent.com/-cdKplcLtL7k/AAAAAAAAAAI/AAAAAAAAAAA/UQiu0rgS-7k/s120-p/photo.jpg","height":120}]},"change_message_id":"281ab5115dfdf7d13d53d8bd309f710c8d409e08","unresolved":false,"context_lines":[],"source_content_type":"","patch_set":11,"id":"400e3d33_4fda66db","in_reply_to":"86cae346_7adc24cc","updated":"2025-06-20 16:00:59.000000000","message":"yes please feel free to! Sorry for having blocked this. I wanted to finish it but I found myself suddenly very bussy and think I won\\u0027t be able to properly finish it for a while more. This is basically missing tests and optionally a split up into smaller CLs (one for support for the `columns` in the trace engine and another for using it in the sources panel).","commit_id":"ec6b7ca7456528616fcbb63e0f23c913686ffe02"},{"author":{"_account_id":1378407,"name":"Connor Clark","email":"cjamcl@chromium.org","avatars":[{"url":"https://lh3.googleusercontent.com/-KhCGGKoypUY/AAAAAAAAAAI/AAAAAAAAAAA/vl5CKC3mHdc/s32-p/photo.jpg","height":32},{"url":"https://lh3.googleusercontent.com/-KhCGGKoypUY/AAAAAAAAAAI/AAAAAAAAAAA/vl5CKC3mHdc/s56-p/photo.jpg","height":56},{"url":"https://lh3.googleusercontent.com/-KhCGGKoypUY/AAAAAAAAAAI/AAAAAAAAAAA/vl5CKC3mHdc/s100-p/photo.jpg","height":100},{"url":"https://lh3.googleusercontent.com/-KhCGGKoypUY/AAAAAAAAAAI/AAAAAAAAAAA/vl5CKC3mHdc/s120-p/photo.jpg","height":120}]},"change_message_id":"b0b93e8dce9f72d190b383ec894c1960792baf51","unresolved":true,"context_lines":[],"source_content_type":"","patch_set":14,"id":"19efcfbe_53921df7","updated":"2025-11-11 16:07:53.000000000","message":"I\\u0027m fairly certain this also adds support for original sources too. While the code was using rawLocationToUILocation, since it had no columns it would most often fail to map to any original sources (for a minified bundle, so for most usages of source maps).\\n\\nNeed to validate but if so: please update CL description to mention that.","commit_id":"253984dbcf149307051d38392d8954fdfce6cfb1"},{"author":{"_account_id":1378407,"name":"Connor Clark","email":"cjamcl@chromium.org","avatars":[{"url":"https://lh3.googleusercontent.com/-KhCGGKoypUY/AAAAAAAAAAI/AAAAAAAAAAA/vl5CKC3mHdc/s32-p/photo.jpg","height":32},{"url":"https://lh3.googleusercontent.com/-KhCGGKoypUY/AAAAAAAAAAI/AAAAAAAAAAA/vl5CKC3mHdc/s56-p/photo.jpg","height":56},{"url":"https://lh3.googleusercontent.com/-KhCGGKoypUY/AAAAAAAAAAI/AAAAAAAAAAA/vl5CKC3mHdc/s100-p/photo.jpg","height":100},{"url":"https://lh3.googleusercontent.com/-KhCGGKoypUY/AAAAAAAAAAI/AAAAAAAAAAA/vl5CKC3mHdc/s120-p/photo.jpg","height":120}]},"change_message_id":"99e70e72fb1d391436f9f6211bb71ce1cf3c2a3a","unresolved":true,"context_lines":[],"source_content_type":"","patch_set":14,"id":"231d643f_58c94095","in_reply_to":"19efcfbe_53921df7","updated":"2025-11-13 08:49:37.000000000","message":"bit of nuance here: original sources were being annotated correctly, but only if the generate source is NOT minified. Otherwise all things would map to the same original line (given column 0 hardcoded).\\n\\nSo in practice.... pretty much all source mapped files would not show profile data correctly ... but only if the generated file is minified. So pretty much all. Notably, not devtools sources though (https://trace.cafe/t/hg5FfFp4QN).","commit_id":"253984dbcf149307051d38392d8954fdfce6cfb1"},{"author":{"_account_id":1378407,"name":"Connor Clark","email":"cjamcl@chromium.org","avatars":[{"url":"https://lh3.googleusercontent.com/-KhCGGKoypUY/AAAAAAAAAAI/AAAAAAAAAAA/vl5CKC3mHdc/s32-p/photo.jpg","height":32},{"url":"https://lh3.googleusercontent.com/-KhCGGKoypUY/AAAAAAAAAAI/AAAAAAAAAAA/vl5CKC3mHdc/s56-p/photo.jpg","height":56},{"url":"https://lh3.googleusercontent.com/-KhCGGKoypUY/AAAAAAAAAAI/AAAAAAAAAAA/vl5CKC3mHdc/s100-p/photo.jpg","height":100},{"url":"https://lh3.googleusercontent.com/-KhCGGKoypUY/AAAAAAAAAAI/AAAAAAAAAAA/vl5CKC3mHdc/s120-p/photo.jpg","height":120}]},"change_message_id":"5005ef2efba5e781dc57a82447671880950d9b84","unresolved":true,"context_lines":[],"source_content_type":"","patch_set":14,"id":"aa69a9e7_c9721f16","in_reply_to":"231d643f_58c94095","updated":"2025-11-18 23:20:58.000000000","message":"```\\nRPP: Support columns, pretty\\u0027d sources in Source\\u0027s panel profile data\\n\\nThe profile data decorations in the Sources panel now apply to the \\u0027-\\u0027\\nlines in Sources when a minified file is pretty-printed, and correctly\\nfor minified + source map\\u0027d scripts.\\n\\nThe Sources panel displays profile data (\\"x ms\\") in the line gutters\\nwhen a performance trace is active. However, we did not handle common\\nedge cases involving pretty-formatted files (the `{}` button), nor did\\nwe handle source mapped content well (we totally ignored column\\ninformation, and since most generated code is minified across few lines,\\nprofile data would be displayed far too coarsely).\\n\\nNow, we utilize the pretty -\\u003e original line mapping to create accurate\\nprofile data for the formatted code; and further we consider the column\\nwhen mapping the profile data to a UILocation.\\n```","commit_id":"253984dbcf149307051d38392d8954fdfce6cfb1"},{"author":{"_account_id":1118499,"name":"Paul Irish","email":"paulirish@chromium.org","avatars":[{"url":"https://lh3.googleusercontent.com/-qmEIdivxI5k/AAAAAAAAAAI/AAAAAAAAAAA/pABmS92o3js/s32-p/photo.jpg","height":32},{"url":"https://lh3.googleusercontent.com/-qmEIdivxI5k/AAAAAAAAAAI/AAAAAAAAAAA/pABmS92o3js/s56-p/photo.jpg","height":56},{"url":"https://lh3.googleusercontent.com/-qmEIdivxI5k/AAAAAAAAAAI/AAAAAAAAAAA/pABmS92o3js/s100-p/photo.jpg","height":100},{"url":"https://lh3.googleusercontent.com/-qmEIdivxI5k/AAAAAAAAAAI/AAAAAAAAAAA/pABmS92o3js/s120-p/photo.jpg","height":120}],"tags":["GOOGLER"]},"change_message_id":"01969a237209c1f963309e078b3a142c30c42881","unresolved":false,"context_lines":[],"source_content_type":"","patch_set":15,"id":"de6d449f_ccda1e30","updated":"2025-11-18 23:09:36.000000000","message":"leaving remainder for connor to adjust.","commit_id":"e7f96884a4af279a60d98dd26f50200536fb0d78"}],"front_end/ui/legacy/components/perf_ui/LineLevelProfile.ts":[{"author":{"_account_id":1378407,"name":"Connor Clark","email":"cjamcl@chromium.org","avatars":[{"url":"https://lh3.googleusercontent.com/-KhCGGKoypUY/AAAAAAAAAAI/AAAAAAAAAAA/vl5CKC3mHdc/s32-p/photo.jpg","height":32},{"url":"https://lh3.googleusercontent.com/-KhCGGKoypUY/AAAAAAAAAAI/AAAAAAAAAAA/vl5CKC3mHdc/s56-p/photo.jpg","height":56},{"url":"https://lh3.googleusercontent.com/-KhCGGKoypUY/AAAAAAAAAAI/AAAAAAAAAAA/vl5CKC3mHdc/s100-p/photo.jpg","height":100},{"url":"https://lh3.googleusercontent.com/-KhCGGKoypUY/AAAAAAAAAAI/AAAAAAAAAAA/vl5CKC3mHdc/s120-p/photo.jpg","height":120}]},"change_message_id":"aa9e04711bf31c7f2011d50c396e5677e3e97bb9","unresolved":true,"context_lines":[{"line_number":199,"context_line":"        const workspace \\u003d Workspace.Workspace.WorkspaceImpl.instance();"},{"line_number":200,"context_line":"        if (debuggerModel) {"},{"line_number":201,"context_line":"          const workspaceBinding \\u003d Bindings.DebuggerWorkspaceBinding.DebuggerWorkspaceBinding.instance();"},{"line_number":202,"context_line":"          for (const [lineNumber, lineData] of lineToDataMap) {"},{"line_number":203,"context_line":"            // lineData contains profiling data by column."},{"line_number":204,"context_line":"            for (const [columnNumber, data] of lineData) {"},{"line_number":205,"context_line":"              const zeroBasedLine \\u003d lineNumber - 1;"}],"source_content_type":"application/typescript","patch_set":14,"id":"e34c35f3_9642dc37","line":202,"updated":"2025-11-11 16:28:35.000000000","message":"I noticed that when something maps to an original source, it removes the profile information for the generated file. If you look at the generated file manually, only the samples that never mapped to anything are shown (so: nothing interesting).\\n\\nI think it\\u0027d be better to add the profile information to both the generated and original source files. Basically: check the uiLocation\\u0027s UISourceCode type (is it type SourceMapScript?) and if so, also update the decoration/profile for the raw location script.","commit_id":"253984dbcf149307051d38392d8954fdfce6cfb1"},{"author":{"_account_id":1378407,"name":"Connor Clark","email":"cjamcl@chromium.org","avatars":[{"url":"https://lh3.googleusercontent.com/-KhCGGKoypUY/AAAAAAAAAAI/AAAAAAAAAAA/vl5CKC3mHdc/s32-p/photo.jpg","height":32},{"url":"https://lh3.googleusercontent.com/-KhCGGKoypUY/AAAAAAAAAAI/AAAAAAAAAAA/vl5CKC3mHdc/s56-p/photo.jpg","height":56},{"url":"https://lh3.googleusercontent.com/-KhCGGKoypUY/AAAAAAAAAAI/AAAAAAAAAAA/vl5CKC3mHdc/s100-p/photo.jpg","height":100},{"url":"https://lh3.googleusercontent.com/-KhCGGKoypUY/AAAAAAAAAAI/AAAAAAAAAAA/vl5CKC3mHdc/s120-p/photo.jpg","height":120}]},"change_message_id":"46a3a0faa75e1c3d7598f2feac5ac12cc2cca9ca","unresolved":true,"context_lines":[{"line_number":199,"context_line":"        const workspace \\u003d Workspace.Workspace.WorkspaceImpl.instance();"},{"line_number":200,"context_line":"        if (debuggerModel) {"},{"line_number":201,"context_line":"          const workspaceBinding \\u003d Bindings.DebuggerWorkspaceBinding.DebuggerWorkspaceBinding.instance();"},{"line_number":202,"context_line":"          for (const [lineNumber, lineData] of lineToDataMap) {"},{"line_number":203,"context_line":"            // lineData contains profiling data by column."},{"line_number":204,"context_line":"            for (const [columnNumber, data] of lineData) {"},{"line_number":205,"context_line":"              const zeroBasedLine \\u003d lineNumber - 1;"}],"source_content_type":"application/typescript","patch_set":14,"id":"28a2ce05_cb163a6f","line":202,"in_reply_to":"e34c35f3_9642dc37","updated":"2025-11-12 10:59:19.000000000","message":"paul: feel free to defer this one / open a new issue for it, as it is a pre-existing issue.","commit_id":"253984dbcf149307051d38392d8954fdfce6cfb1"},{"author":{"_account_id":1378407,"name":"Connor Clark","email":"cjamcl@chromium.org","avatars":[{"url":"https://lh3.googleusercontent.com/-KhCGGKoypUY/AAAAAAAAAAI/AAAAAAAAAAA/vl5CKC3mHdc/s32-p/photo.jpg","height":32},{"url":"https://lh3.googleusercontent.com/-KhCGGKoypUY/AAAAAAAAAAI/AAAAAAAAAAA/vl5CKC3mHdc/s56-p/photo.jpg","height":56},{"url":"https://lh3.googleusercontent.com/-KhCGGKoypUY/AAAAAAAAAAI/AAAAAAAAAAA/vl5CKC3mHdc/s100-p/photo.jpg","height":100},{"url":"https://lh3.googleusercontent.com/-KhCGGKoypUY/AAAAAAAAAAI/AAAAAAAAAAA/vl5CKC3mHdc/s120-p/photo.jpg","height":120}]},"change_message_id":"aa9e04711bf31c7f2011d50c396e5677e3e97bb9","unresolved":true,"context_lines":[{"line_number":208,"context_line":"                const rawLocation \\u003d typeof scriptIdOrUrl \\u003d\\u003d\\u003d \\u0027string\\u0027 ?"},{"line_number":209,"context_line":"                    debuggerModel.createRawLocationByURL(scriptIdOrUrl, zeroBasedLine, zeroBasedColumn || 0) :"},{"line_number":210,"context_line":"                    debuggerModel.createRawLocationByScriptId("},{"line_number":211,"context_line":"                        String(scriptIdOrUrl) as Protocol.Runtime.ScriptId, zeroBasedLine, 0);"},{"line_number":212,"context_line":"                if (rawLocation) {"},{"line_number":213,"context_line":"                  pending.push(workspaceBinding.rawLocationToUILocation(rawLocation).then(uiLocation \\u003d\\u003e {"},{"line_number":214,"context_line":"                    if (uiLocation) {"}],"source_content_type":"application/typescript","patch_set":14,"id":"a34ee841_067fd30a","line":211,"updated":"2025-11-11 16:28:35.000000000","message":"createRawLocationByScriptId is not passing the column. This is preventing original sources from being mapped correctly.","commit_id":"253984dbcf149307051d38392d8954fdfce6cfb1"},{"author":{"_account_id":1118499,"name":"Paul Irish","email":"paulirish@chromium.org","avatars":[{"url":"https://lh3.googleusercontent.com/-qmEIdivxI5k/AAAAAAAAAAI/AAAAAAAAAAA/pABmS92o3js/s32-p/photo.jpg","height":32},{"url":"https://lh3.googleusercontent.com/-qmEIdivxI5k/AAAAAAAAAAI/AAAAAAAAAAA/pABmS92o3js/s56-p/photo.jpg","height":56},{"url":"https://lh3.googleusercontent.com/-qmEIdivxI5k/AAAAAAAAAAI/AAAAAAAAAAA/pABmS92o3js/s100-p/photo.jpg","height":100},{"url":"https://lh3.googleusercontent.com/-qmEIdivxI5k/AAAAAAAAAAI/AAAAAAAAAAA/pABmS92o3js/s120-p/photo.jpg","height":120}],"tags":["GOOGLER"]},"change_message_id":"01969a237209c1f963309e078b3a142c30c42881","unresolved":false,"context_lines":[{"line_number":208,"context_line":"                const rawLocation \\u003d typeof scriptIdOrUrl \\u003d\\u003d\\u003d \\u0027string\\u0027 ?"},{"line_number":209,"context_line":"                    debuggerModel.createRawLocationByURL(scriptIdOrUrl, zeroBasedLine, zeroBasedColumn || 0) :"},{"line_number":210,"context_line":"                    debuggerModel.createRawLocationByScriptId("},{"line_number":211,"context_line":"                        String(scriptIdOrUrl) as Protocol.Runtime.ScriptId, zeroBasedLine, 0);"},{"line_number":212,"context_line":"                if (rawLocation) {"},{"line_number":213,"context_line":"                  pending.push(workspaceBinding.rawLocationToUILocation(rawLocation).then(uiLocation \\u003d\\u003e {"},{"line_number":214,"context_line":"                    if (uiLocation) {"}],"source_content_type":"application/typescript","patch_set":14,"id":"01a3e277_50bcf4a1","line":211,"in_reply_to":"a34ee841_067fd30a","updated":"2025-11-18 23:09:36.000000000","message":"Done","commit_id":"253984dbcf149307051d38392d8954fdfce6cfb1"}]}\n';
}