#
# Aerospike Server For large cluster testing
#
#

FROM ubuntu:18.04
MAINTAINER Ashish Shinde

# Install dependencies
RUN sed -i -e 's/http:\/\/archive/mirror:\/\/mirrors/' -e 's/\(mirror:\/\/mirrors.*\)\/ubuntu\//\1\/mirrors.txt\//' /etc/apt/sources.list
RUN rm -rf /var/lib/apt/lists/*
RUN apt-get update
RUN apt-get install -y -q wget python iptables telnet vim rsyslog net-tools netcat iputils-ping openssh-server build-essential git file
RUN apt-get install -y systemd
RUN systemctl enable ssh.service
RUN systemctl disable getty\@.service
RUN systemctl mask getty\@.service

# Install asinfo
RUN \
wget -O aerospike-tools.tgz 'http://aerospike.com/download/tools/latest/artifact/ubuntu16' && \
tar -xvf aerospike-tools.tgz && \
cd aerospike-tools-*-ubuntu*/ && \
./asinstall && \
cd .. && \
rm -rf aerospike-tools.tgz aerospike-tools-*-ubuntu*

# Disable logrotate
RUN rm /etc/logrotate.d/aerospike* || true

# Set up root login from ssh
RUN echo 'root:root' |chpasswd
RUN sed -ri 's/^#?\s*PermitRootLogin\s+.*/PermitRootLogin yes/' /etc/ssh/sshd_config
RUN sed -ri 's/^#?\s*GSSAPIAuthentication\s+.*/GSSAPIAuthentication no/' /etc/ssh/sshd_config
RUN sed -ri 's/^#?\s*UseDNS\s+.*/UseDNS no/' /etc/ssh/sshd_config
RUN sed -ri 's/^\s*UsePAM yes/#UsePAM yes/g' /etc/ssh/sshd_config

# Create ssh directories
RUN mkdir /var/run/sshd
RUN chmod 0755 /var/run/sshd

#fake time lib
RUN \
cd /tmp && \
git clone https://github.com/wolfcw/libfaketime.git && \
cd libfaketime && \
make && \
make install

# cleanup
RUN apt-get clean

EXPOSE 22

CMD ["/sbin/init"]
