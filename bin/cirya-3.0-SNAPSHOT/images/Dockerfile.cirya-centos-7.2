#
# Aerospike Server centos 7 cluster testing
#
#

FROM centos:7.2.1511
MAINTAINER Ashish Shinde

# Install dependencies
RUN yum clean all
RUN yum install -y yum-plugin-ovl
RUN yum install -y git wget python iptables telnet vim rsyslog net-tools netcat iputils-ping openssh-server make gcc file
RUN yum install -y systemd
RUN systemctl enable sshd.service
RUN systemctl disable getty\@.service
RUN systemctl mask getty\@.service

# Install asinfo
RUN \
wget -O aerospike-tools.tgz 'http://aerospike.com/download/tools/latest/artifact/el7' && \
tar -xvf aerospike-tools.tgz && \
cd aerospike-tools-*-el7* && \
./asinstall && \
cd .. && \
rm -rf aerospike-tools.tgz aerospike-tools-*-el7*

# Disable logrotate
RUN rm /etc/logrotate.d/aerospike* || true

# Set up root login from ssh
RUN echo 'root:root' |chpasswd
RUN sed -ri 's/^PermitRootLogin\s+.*/PermitRootLogin yes/' /etc/ssh/sshd_config
RUN sed -ri 's/^GSSAPIAuthentication\s+.*/GSSAPIAuthentication no/' /etc/ssh/sshd_config
RUN sed -ri 's/^UseDNS\s+.*/UseDNS no/' /etc/ssh/sshd_config
RUN sed -ri 's/^#UseDNS\s+.*/UseDNS no/' /etc/ssh/sshd_config
RUN sed -ri 's/UsePAM yes/#UsePAM yes/g' /etc/ssh/sshd_config

# Create ssh directories
RUN mkdir /var/run/sshd
RUN chmod 0755 /var/run/sshd

# cleanup
RUN yum -y clean all
EXPOSE 22

#fake time lib
RUN \
cd /tmp && \
git clone https://github.com/wolfcw/libfaketime.git && \
cd libfaketime && \
make && \
make install

CMD ["/sbin/init"]
